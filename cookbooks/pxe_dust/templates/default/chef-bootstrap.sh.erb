. /etc/profile
if [ ! -f /usr/bin/chef-client ]; then
   # setup name servers so chef client can connect
   printf "nameserver 10.0.28.2\nnameserver 10.0.27.102" > /etc/resolv.conf

   # add opscode apt repo
   echo "deb http://apt.opscode.com/ precise-0.10 main" >> /etc/apt.sources.list

   # set chef URL selection prior to installing 
   echo "chef chef/chef_server_url string http://chef.bos1:4000" | debconf-set-selections

   # install chef
   apt-get update
   apt-get install chef opscode-keyring -y --force-yes

   #wget -q -O /tmp/<%= @installer %> http://<%= node[:ipaddress] %>/opscode-full-stack/<%= @release %>/<%= @installer %>
   #dpkg -i /tmp/<%= @installer %>
fi

#mkdir -p /etc/chef

#cat > /etc/chef/client.rb <<EOF
#log_level        :info
#log_location     STDOUT

#chef_server_url  '<%= Chef::Config[:chef_server_url] %>'
#validation_client_name '<%= Chef::Config[:validation_client_name] %>'

#<% if @http_proxy %>http_proxy 'http://<%= @http_proxy %>'<% end %>
#<% if @https_proxy %>http_proxy 'https://<%= @https_proxy %>'<% end %>
#<% if @http_proxy_user %>http_proxy_user 'http://<%= @http_proxy_user %>'<% end %>
#<% if @http_proxy_pass %>http_proxy_pass 'http://<%= @http_proxy_pass %>'<% end %>
#EOF

cat > /etc/chef/first-boot.json <<EOF
{
<% if @run_list %>"run_list": [ "<%= @run_list %>" ]<% end %>
}
EOF

wget -O /etc/chef/validation.pem http://<%= node[:ipaddress] %>/validation.pem

#make chef-client a little more reliable on first run
#apt-get update
#for use with ps
mount /proc

/usr/bin/chef-client -j /etc/chef/first-boot.json 2>&1 | /usr/bin/tee /root/chef-firstboot.log

#rm /tmp/<%= @installer %>
